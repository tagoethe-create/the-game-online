<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>The Game ‚Äì Online</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
:root{ --bg:#121212; --panel:#1e1e1e; --card:#2c2c2c; --accent:#4caf50; --text:#f2f2f2; --muted:#a0a0a0; }
body{ margin:0; padding:16px; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; text-align:center; }
h1{ margin:8px 0 12px; }

#controls{ display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-bottom:10px; }
input, button{ font-size:16px; padding:12px 14px; border-radius:12px; border:none; }
input{ min-width:170px; }
button{ background:var(--accent); color:#0b0b0b; cursor:pointer; min-height:44px; }
button.secondary{ background:#2b2b2b; color:var(--text); }

#topbar{ display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin:10px 0 6px; color:var(--muted); }

#pingbar{ display:flex; justify-content:center; gap:8px; flex-wrap:wrap; margin:10px 0 4px; }
.pingbtn{ background:#2b2b2b; color:var(--text); }

.piles{ display:grid; grid-template-columns:repeat(2, minmax(140px, 160px)); gap:14px; justify-content:center; margin:14px 0; }
.pile{ background:var(--panel); border:2px solid #555; border-radius:16px; padding:14px 10px; user-select:none; min-height:78px; display:flex; flex-direction:column; justify-content:center; cursor:pointer; }
.pile strong{ font-size:28px; margin-top:4px; display:block; }
.pile span{ font-size:13px; color:var(--muted); }
.pile.valid{ border-color:var(--accent); box-shadow:0 0 10px rgba(76,175,80,.7); }

#hand{ margin-top:10px; }
.card{ display:inline-block; background:var(--card); padding:14px 18px; margin:8px; border-radius:16px; font-size:18px; min-width:56px; user-select:none; cursor:pointer; }
.card.selected{ outline:2px solid var(--accent); box-shadow:0 0 10px rgba(76,175,80,.7); }

#actions{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-top:10px; }
#endTurnBtn{ display:none; }

#toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#000c; color:var(--text); padding:10px 14px; border-radius:14px; display:none; z-index:9999; max-width:min(520px, 92vw); }

#overlay{ position:fixed; inset:0; background:rgba(0,0,0,.72); display:none; align-items:center; justify-content:center; z-index:9998; padding:18px; }
#overlay .box{ width:min(520px, 92vw); background:var(--panel); border:2px solid #555; border-radius:18px; padding:16px; }
#overlay h2{ margin:6px 0 10px; }

@media (max-width:420px){
  input{ min-width:150px; }
  .piles{ grid-template-columns:repeat(2, minmax(140px, 1fr)); }
}
</style>
</head>

<body>
<h1>The Game üÉè</h1>

<div id="controls">
  <input id="room" placeholder="Lobby-Code">
  <input id="name" placeholder="Name (optional)">
  <input id="maxPlayers" type="number" min="2" max="4" value="2" style="width:90px" title="2‚Äì4 Spieler">
  <button onclick="create()">Lobby erstellen</button>
  <button class="secondary" onclick="join()">Beitreten</button>
</div>

<div id="topbar">
  <div id="lobbyInfo"></div>
  <div id="deckInfo"></div>
  <div id="turnInfo"></div>
  <div id="statsInfo"></div>
</div>

<div id="pingbar">
  <button class="pingbtn" onclick="sendPing('have')">üëÄ Ich hab was</button>
  <button class="pingbtn" onclick="sendPing('dont')">üö´ Bitte nicht</button>
  <button class="pingbtn" onclick="sendPing('ok')">‚úÖ Ok</button>
  <button class="pingbtn" onclick="sendPing('?')">‚ùì</button>
</div>

<div class="piles" id="piles"></div>

<h2>Deine Karten</h2>
<div id="hand"></div>

<div id="actions">
  <button id="endTurnBtn" onclick="endTurn()">Zug beenden</button>
</div>

<div id="overlay"></div>
<div id="toast"></div>

<script>
const SERVER_URL = "https://the-game-server-h9br.onrender.com";
const socket = io(SERVER_URL);

let room="", myId="", state=null, myHand=[], selectedCard=null;
let audioCtx=null;

function beep(freq=440, ms=70){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type="sine"; o.frequency.value=freq;
    g.gain.value=0.06;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>o.stop(), ms);
  }catch(e){}
}

let toastTimer=null;
function toast(text){
  const t=document.getElementById("toast");
  t.innerText=text;
  t.style.display="block";
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.style.display="none", 1800);
}

function create(){
  room=document.getElementById("room").value.trim();
  if(!room) return alert("Bitte Lobby-Code eingeben");
  const maxPlayers=Math.max(2, Math.min(4, parseInt(document.getElementById("maxPlayers").value || "2")));
  socket.emit("create", { room, maxPlayers });
  join();
}

function join(){
  room=document.getElementById("room").value.trim();
  if(!room) return alert("Bitte Lobby-Code eingeben");
  const name=document.getElementById("name").value.trim();
  socket.emit("join", { room, name });
  beep(520,60);
}

socket.on("errorMsg", (msg)=> alert(msg));

socket.on("state", (s)=>{
  state=s;
  myId=socket.id;
  render();
});

socket.on("hand", (hand)=>{
  myHand=hand||[];
  renderHand();
});

socket.on("ping", ({from, type})=>{
  const map={have:"üëÄ", dont:"üö´", ok:"‚úÖ", "?":"‚ùì"};
  toast(`${map[type]||"üîî"} ${from}: ${type}`);
  beep(880,70);
});

function isValid(card, pileName, pileValue){
  return pileName.startsWith("up")
    ? (card>pileValue || card===pileValue-10)
    : (card<pileValue || card===pileValue+10);
}

function hasAnyLegalMove(){
  if(!state) return false;
  for(const c of (myHand||[])){
    for(const p in state.piles){
      if(isValid(c, p, state.piles[p])) return true;
    }
  }
  return false;
}

function minPlaysThisTurn(){
  // ‚úÖ Deck leer -> 1, sonst 2
  return (state && state.deckCount === 0) ? 1 : 2;
}

function showOverlay(html){
  const ov=document.getElementById("overlay");
  ov.innerHTML=`<div class="box">${html}</div>`;
  ov.style.display="flex";
}
function hideOverlay(){
  const ov=document.getElementById("overlay");
  ov.style.display="none";
  ov.innerHTML="";
}

let lastEndSound=null;
let lastHint="";

function render(){
  if(!state) return;

  const joined=Object.keys(state.players||{}).length;
  document.getElementById("lobbyInfo").innerText=`Lobby: ${state.room} ‚Ä¢ Spieler: ${joined}/${state.maxPlayers}`;
  document.getElementById("deckInfo").innerText=`Deck: ${state.deckCount}`;
  document.getElementById("statsInfo").innerText=`Stats: ${state.stats?.wins||0}W / ${state.stats?.losses||0}L (Games: ${state.stats?.games||0})`;

  const isMyTurn = state.status==="playing" && state.turn===myId;
  const played = state.playedThisTurn?.[myId] ?? 0;
  const minPlays = minPlaysThisTurn();

  if(state.status==="waiting"){
    document.getElementById("turnInfo").innerText=`Warte bis Lobby voll ist‚Ä¶ (${joined}/${state.maxPlayers})`;
  } else if(state.status==="playing"){
    document.getElementById("turnInfo").innerText = isMyTurn
      ? `DEIN ZUG ‚Ä¢ gespielt: ${played}/${minPlays} ${state.deckCount===0 ? "(Deck leer)" : ""}`
      : `Jemand anderes ist dran`;
  } else {
    document.getElementById("turnInfo").innerText="";
  }

  // Button zeigen, wenn: dein Zug UND (>=minPlays ODER Pass m√∂glich)
  const endBtn=document.getElementById("endTurnBtn");
  const canPass = isMyTurn && !hasAnyLegalMove();
  endBtn.style.display = (isMyTurn && (played>=minPlays || canPass)) ? "inline-block" : "none";

  // kleine Hinweise ohne Spam
  if(isMyTurn && canPass && lastHint!=="pass"){
    toast("Du hast keinen legalen Zug ‚Üí du kannst passen (Zug beenden).");
    lastHint="pass";
  }
  if(isMyTurn && !canPass && played<minPlays && lastHint!=="need"){
    // nur einmal anzeigen
    lastHint="need";
  }
  if(!isMyTurn) lastHint="";

  if(state.status==="win" || state.status==="lose"){
    showOverlay(`
      <h2>${state.status==="win" ? "üéâ GEWONNEN" : "üíÄ VERLOREN"}</h2>
      <p style="color:var(--muted); margin-top:0;">Rematch startet neue Partie, Stats bleiben.</p>
      <button onclick="rematch()">Rematch</button>
    `);
    const tag = state.status;
    if(lastEndSound !== tag){
      beep(state.status==="win" ? 660 : 200, 180);
      lastEndSound = tag;
    }
  } else {
    hideOverlay();
    lastEndSound = null;
  }

  // Piles
  const pilesDiv=document.getElementById("piles");
  pilesDiv.innerHTML="";
  for(const p in state.piles){
    const val=state.piles[p];
    const d=document.createElement("div");
    d.className="pile";
    d.innerHTML=`<span>${p.startsWith("up") ? "‚Üë aufsteigend" : "‚Üì absteigend"}</span><strong>${val}</strong>`;
    if(selectedCard!==null && isValid(selectedCard, p, val)) d.classList.add("valid");
    d.onclick=()=>tryPlay(p);
    pilesDiv.appendChild(d);
  }

  renderHand();
}

function renderHand(){
  const handDiv=document.getElementById("hand");
  handDiv.innerHTML="";
  (myHand||[]).forEach((c)=>{
    const el=document.createElement("div");
    el.className="card" + (selectedCard===c ? " selected" : "");
    el.innerText=c;
    el.onclick=()=>{ selectedCard=c; beep(520,40); render(); };
    handDiv.appendChild(el);
  });
}

function tryPlay(pile){
  if(!state || state.status!=="playing") return;
  if(state.turn!==myId) return toast("Nicht dein Zug.");
  if(selectedCard===null) return toast("Erst eine Karte ausw√§hlen.");

  const ok=isValid(selectedCard, pile, state.piles[pile]);
  if(!ok) return toast("Dort nicht erlaubt.");

  socket.emit("play", { room, card:selectedCard, pile });
  beep(740,55);
  selectedCard=null;
}

function endTurn(){
  socket.emit("endTurn", { room });
  beep(600,70);
}

function rematch(){
  socket.emit("rematch", { room });
  selectedCard=null;
  beep(520,70);
}

function sendPing(type){
  if(!room) return toast("Erst Lobby beitreten.");
  socket.emit("ping", { room, type });
  beep(880,60);
}
</script>
</body>
</html>
