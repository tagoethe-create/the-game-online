<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>The Game ‚Äì Online</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body {
  background:#121212;
  color:#f2f2f2;
  font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  text-align:center;
  padding:20px;
  margin:0;
}

h1 { margin: 10px 0 16px; }

#controls{
  display:flex;
  justify-content:center;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:14px;
}

input, button {
  padding:10px 14px;
  border-radius:10px;
  border:none;
  font-size:16px;
}

input { min-width: 180px; }

button {
  background:#4caf50;
  cursor:pointer;
}

button:active { transform: scale(0.98); }

.piles {
  display:grid;
  grid-template-columns:repeat(2,150px);
  gap:16px;
  justify-content:center;
  margin-top:16px;
}

.pile {
  background:#1e1e1e;
  border:2px solid #555;
  border-radius:14px;
  padding:16px 12px;
  cursor:pointer;
  user-select:none;
}

.pile.valid {
  border-color:#4caf50;
  box-shadow:0 0 10px #4caf50;
}

#hand { margin-top:14px; }

.card {
  background:#2c2c2c;
  display:inline-block;
  padding:14px 18px;
  margin:8px;
  border-radius:14px;
  cursor:pointer;
  font-size:18px;
  min-width:56px;
  user-select:none;
}

.card.selected {
  outline: 2px solid #4caf50;
  box-shadow: 0 0 10px #4caf50;
}

#endTurn { display:none; margin-top:14px; }

/* ‚úÖ WICHTIG: Overlay ist standardm√§√üig AUS */
#overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:none;                 /* <<< FIX */
  justify-content:center;
  align-items:center;
  flex-direction:column;
  z-index:9999;
  padding:20px;
}
#overlay .box{
  background:#1e1e1e;
  border:2px solid #555;
  border-radius:16px;
  padding:18px 16px;
  width:min(420px, 90vw);
}
#overlay h1{ margin: 0 0 12px; }
</style>
</head>

<body>
<h1>The Game üÉè</h1>

<div id="controls">
  <input id="room" placeholder="Lobby-Code">
  <input id="maxPlayers" placeholder="Spieleranzahl (2-4)" type="number" min="2" max="4" value="2">
  <button onclick="create()">Lobby erstellen</button>
  <button onclick="join()">Beitreten</button>
</div>

<h3 id="info"></h3>

<div id="piles" class="piles"></div>

<h2>Deine Karten</h2>
<div id="hand"></div>

<button id="endTurn" onclick="endTurn()">Zug beenden</button>

<div id="overlay"></div>

<script>
const SERVER_URL = "https://the-game-server-h9br.onrender.com";
const socket = io(SERVER_URL);

let room = "";
let myId = "";
let game = null;
let selectedCard = null;

function create(){
  const maxPlayers = Math.max(2, Math.min(4, parseInt(document.getElementById("maxPlayers").value || "2")));
  room = document.getElementById("room").value.trim();
  if(!room) return alert("Bitte Lobby-Code eingeben");
  socket.emit("create", { room, maxPlayers });
  // danach direkt beitreten
  socket.emit("join", room);
}

function join(){
  room = document.getElementById("room").value.trim();
  if(!room) return alert("Bitte Lobby-Code eingeben");
  socket.emit("join", room);
}

socket.on("error", (msg) => alert(msg));

socket.on("state", g=>{
  game = g;
  myId = socket.id; // socket.id ist zuverl√§ssig
  render();
});

function isValid(card, pile, val){
  return pile.startsWith("up")
    ? (card > val || card === val - 10)
    : (card < val || card === val + 10);
}

function showOverlay(html){
  const ov = document.getElementById("overlay");
  ov.innerHTML = `<div class="box">${html}</div>`;
  ov.style.display = "flex";
}

function hideOverlay(){
  const ov = document.getElementById("overlay");
  ov.style.display = "none";
  ov.innerHTML = "";
}

function render(){
  if(!game) return;

  // ‚úÖ Overlay korrekt an/aus
  if(game.status !== "playing" && game.status !== "waiting"){
    showOverlay(`
      <h1>${game.status === "win" ? "üéâ You won!" : "üíÄ You lost!"}</h1>
      <button onclick="rematch()">Rematch</button>
    `);
  } else {
    hideOverlay();
  }

  // Info
  let info = "";
  if(game.status === "waiting"){
    info = `Warte auf Spieler: ${Object.keys(game.players).length}/${game.maxPlayers}`;
  } else if(game.turn === myId){
    info = `Dein Zug ‚Äì Karten gespielt: ${game.playedThisTurn?.[myId] ?? 0}/2`;
  } else {
    info = "Warten auf Mitspieler";
  }
  document.getElementById("info").innerText = info;

  // EndTurn Button
  const played = game.playedThisTurn?.[myId] ?? 0;
  document.getElementById("endTurn").style.display =
    (game.turn === myId && played >= 2) ? "inline-block" : "none";

  // Piles
  const pilesDiv = document.getElementById("piles");
  pilesDiv.innerHTML = "";
  for(const p in game.piles){
    const d = document.createElement("div");
    d.className = "pile";
    d.innerText = `${p}\n${game.piles[p]}`;

    if(selectedCard !== null && isValid(selectedCard, p, game.piles[p])){
      d.classList.add("valid");
    }

    d.onclick = () => play(p);
    pilesDiv.appendChild(d);
  }

  // Hand
  const hand = document.getElementById("hand");
  hand.innerHTML = "";
  (game.players?.[myId] || []).forEach(c=>{
    const el = document.createElement("div");
    el.className = "card" + (selectedCard === c ? " selected" : "");
    el.innerText = c;
    el.onclick = () => { selectedCard = c; render(); };
    hand.appendChild(el);
  });
}

function play(pile){
  if(game?.status !== "playing") return;
  if(game.turn !== myId) return;
  if(selectedCard === null) return;

  socket.emit("play", { room, card: selectedCard, pile });
  // ausgew√§hlte Karte nach Versuch abw√§hlen (Server entscheidet)
  selectedCard = null;
}

function endTurn(){
  socket.emit("endTurn", room);
}

function rematch(){
  socket.emit("rematch", room);
}
</script>
</body>
</html>
