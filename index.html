<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>The Game ‚Äì Online</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
/* (Dein CSS kann 1:1 bleiben ‚Äì ich k√ºrze hier NICHT, aber du kannst einfach dein CSS behalten) */
:root{
  --bg:#121212;
  --text:#f2f2f2;
  --muted:#a0a0a0;
  --accent:#4caf50;
  --danger:#ff5252;

  --paper1:#f3e6c8;
  --paper2:#efe0bf;
  --paper3:#ead9b4;

  --paperBorder: rgba(120,70,40,.35);
  --paperInner: rgba(255,255,255,.55);

  --redFrame: rgba(109, 27, 23);
  --greenFrame: rgba(60, 101, 56);
}

*{ box-sizing:border-box; }

body{
  margin:0; padding:16px;
  background:
    radial-gradient(900px 520px at 50% 0%, rgba(255,255,255,.05), rgba(255,255,255,0) 60%),
    radial-gradient(900px 520px at 50% 100%, rgba(0,0,0,.35), rgba(0,0,0,.7) 70%),
    linear-gradient(180deg, #111 0%, #0f0f0f 100%);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  text-align:center;
}

h1{ margin:8px 0 12px; font-weight:800; letter-spacing:.3px; }

#controls{
  display:flex; flex-wrap:wrap; justify-content:center;
  gap:10px; margin-bottom:10px;
}

input, button{
  font-size:16px;
  padding:12px 14px;
  border-radius:12px;
  border:none;
}

input{
  min-width:170px;
  background:#f3f3f3;
  color:#111;
}

button{
  background:var(--accent);
  color:#0b0b0b;
  cursor:pointer;
  min-height:44px;
  font-weight:700;
}
button.secondary{
  background:#2b2b2b;
  color:var(--text);
  font-weight:650;
}

#topbar{
  display:flex; flex-wrap:wrap; justify-content:center;
  gap:10px; margin:10px 0 6px;
  color:var(--muted);
}

#turnInfoWrap{
  display:flex;
  align-items:center;
  gap:10px;
  justify-content:center;
}

/* Turn ring */
.turnRing{
  width:18px;
  height:18px;
  border-radius:999px;
  border:2px solid rgba(160,160,160,.35);
  border-top-color: rgba(160,160,160,.8);
  opacity:.9;
  transition: border-color .25s ease, border-top-color .25s ease;
}
.turnRing.myTurn{
  border-color: rgba(255,82,82,.45);
  border-top-color: var(--danger);
}
.turnRing.otherTurn{
  border-color: rgba(60, 101, 56);
  border-top-color: var(--accent);
}
.turnRing.spinning{
  animation: turnSpin 1.15s linear infinite;
}
@keyframes turnSpin{
  from{ transform: rotate(0deg); }
  to{ transform: rotate(360deg); }
}

/* Ping bar */
#pingbar{
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
  margin:12px 0 8px;
}
.pingchip{
  background:#2b2b2b;
  color:var(--text);
  padding:12px 14px;
  border-radius:14px;
  cursor:grab;
  user-select:none;
  border:1px solid #3a3a3a;
  min-height:44px;
  display:flex;
  align-items:center;
  gap:8px;
  box-shadow: 0 10px 18px rgba(0,0,0,.25);
}
.pingchip:active{ cursor:grabbing; transform:scale(0.99); }
.pingchip.armed{
  outline:2px solid var(--accent);
  box-shadow:0 0 10px rgba(60, 101, 56);
}

/* ‚úÖ PILES: always 2√ó2 */
.piles{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap:26px 34px;
  justify-content:center;
  margin:22px auto 10px;
  width:max-content;
}

.pile{
  position:relative;
  width:92px;
  height:132px;
  border-radius:16px;
  cursor:pointer;

  background-color: var(--paper2);
  background-image:
    radial-gradient(120px 80px at 30% 20%, rgba(255,255,255,.55), rgba(255,255,255,0) 60%),
    radial-gradient(140px 100px at 70% 80%, rgba(0,0,0,.06), rgba(0,0,0,0) 60%),
    linear-gradient(180deg, var(--paper1) 0%, var(--paper2) 60%, var(--paper3) 100%);

  border:2px solid var(--paperBorder);
  box-shadow:
    inset 0 0 0 3px var(--paperInner),
    0 12px 26px rgba(0,0,0,.45);

  display:flex;
  align-items:center;
  justify-content:center;

  font-family: ui-serif, "Georgia", "Times New Roman", Times, serif;
  font-weight:900;
  font-size:34px;
  color:#111;

  transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
  transform: translateZ(0);
}

.pile.up{
  box-shadow:
    inset 0 0 0 3px var(--paperInner),
    inset 0 0 0 6px var(--greenFrame),
    0 12px 26px rgba(0,0,0,.45);
}
.pile.down{
  box-shadow:
    inset 0 0 0 3px var(--paperInner),
    inset 0 0 0 6px var(--redFrame),
    0 12px 26px rgba(0,0,0,.45);
}

.pile .arrow{
  position:absolute;
  top:-18px;
  font-size:18px;
  opacity:.82;
  font-weight:900;
}
.pile.up .arrow{ color: var(--accent); }
.pile.down .arrow{ color: rgba(109, 27, 23); }

.pile:hover{ transform: translateY(-3px); }

.pile.valid{ outline: 3px solid rgba(60, 101, 56); }

.pile .pilePing{
  position:absolute;
  top:-12px;
  right:-12px;
  font-size:26px;
  filter:drop-shadow(0 0 6px rgba(0,0,0,.55));
}
.pile.blocked{ filter: grayscale(0.25); opacity:.7; }

/* CARDS */
#hand{ margin-top:10px; }

.card{
  position:relative;
  display:inline-flex;
  align-items:center;
  justify-content:center;

  width:74px;
  height:108px;
  margin:10px;

  border-radius:16px;

  background-color: var(--paper2);
  background-image:
    radial-gradient(120px 80px at 30% 20%, rgba(255,255,255,.55), rgba(255,255,255,0) 60%),
    radial-gradient(140px 100px at 70% 80%, rgba(0,0,0,.06), rgba(0,0,0,0) 60%),
    linear-gradient(180deg, var(--paper1) 0%, var(--paper2) 50%, var(--paper3) 100%);

  border:2px solid var(--paperBorder);

  box-shadow:
    inset 0 0 0 3px var(--paperInner),
    inset 0 0 0 6px rgba(109, 27, 23),
    0 10px 22px rgba(0,0,0,.45);

  color:#111;
  cursor:pointer;
  user-select:none;

  font-size:36px;
  font-weight:900;
  letter-spacing:0.5px;
  font-family: ui-serif, "Georgia", "Times New Roman", Times, serif;

  transition: transform .14s ease, box-shadow .14s ease;
  transform: translateZ(0);
}

.card::before,
.card::after{
  content: attr(data-value);
  position:absolute;
  color:#111;
  font-family: ui-serif, "Georgia", "Times New Roman", Times, serif;
  font-weight:800;
  font-size:14px;
  letter-spacing:0.2px;
  opacity:.9;
}
.card::before{ top:8px; left:10px; }
.card::after{ bottom:8px; right:10px; transform: rotate(180deg); }

.card:hover{ transform: translateY(-4px); }
.card.selected{ transform: translateY(-7px) scale(1.03); }
.card:active{ transform: scale(0.97); }

/* Actions */
#actions{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-top:10px; }
#endTurnBtn{ display:none; }

/* Toast */
#toast{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:18px;
  background:#000c; color:var(--text);
  padding:10px 14px;
  border-radius:14px;
  display:none;
  z-index:9999;
  max-width:min(520px, 92vw);
}

/* Overlay */
#overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.72);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9998;
  padding:18px;
}
#overlay .box{
  width:min(560px, 94vw);
  background:rgba(30,30,30,.96);
  border:2px solid #555;
  border-radius:18px;
  padding:16px;
  box-shadow: 0 20px 60px rgba(0,0,0,.6);
}
#overlay h2{ margin:6px 0 10px; }

.choiceRow{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:12px; }
.choiceBtn{ min-width:200px; }
.choiceBtn.secondary{ background:#2b2b2b; color:var(--text); }
.choiceStatus{ margin-top:10px; color:var(--muted); font-size:14px; }

/* Flying card */
.flyingCard{
  position:fixed; z-index:10000; pointer-events:none;
  background-color: var(--paper2);
  background-image:
    radial-gradient(120px 80px at 30% 20%, rgba(255,255,255,.55), rgba(255,255,255,0) 60%),
    radial-gradient(140px 100px at 70% 80%, rgba(0,0,0,.06), rgba(0,0,0,0) 60%),
    linear-gradient(180deg, var(--paper1) 0%, var(--paper2) 50%, var(--paper3) 100%);
  border:2px solid var(--paperBorder);
  box-shadow:
    inset 0 0 0 3px var(--paperInner),
    inset 0 0 0 6px rgba(109, 27, 23),
    0 16px 34px rgba(0,0,0,.60);
  color:#111;
  font-family: ui-serif, "Georgia", "Times New Roman", Times, serif;
  font-weight:900; font-size:36px;
  border-radius:16px;
  min-width:74px; min-height:108px;
  display:flex; align-items:center; justify-content:center;
  transform: translate(-50%, -50%) translateZ(0);
  will-change: transform, opacity;
}

@media (max-width:420px){
  input{ min-width:150px; }
  .pile{ width:86px; height:124px; }
  .card{ width:70px; height:102px; }
}
</style>
</head>

<body>
<h1>The Game üÉè</h1>

<div id="controls">
  <input id="room" placeholder="Lobby-Code">
  <input id="name" placeholder="Name (optional)">
  <input id="maxPlayers" type="number" min="2" max="4" value="2" style="width:90px" title="2‚Äì4 Spieler">
  <button onclick="create()">Lobby erstellen</button>
  <button class="secondary" onclick="join()">Beitreten</button>
</div>

<div id="topbar">
  <div id="lobbyInfo"></div>
  <div id="deckInfo"></div>

  <div id="turnInfoWrap">
    <div id="turnRing" class="turnRing" aria-hidden="true"></div>
    <div id="turnInfo"></div>
  </div>

  <div id="statsInfo"></div>
</div>

<div id="pingbar">
  <div id="chipHave" class="pingchip" draggable="true" data-type="have">üëÄ <span>Ich hab was</span></div>
  <div id="chipDont" class="pingchip" draggable="true" data-type="dont">üö´ <span>Bitte nicht</span></div>
</div>

<div class="piles" id="piles"></div>

<h2>Deine Karten</h2>
<div id="hand"></div>

<div id="actions">
  <button id="endTurnBtn" onclick="endTurn()">Zug beenden</button>
</div>

<div id="overlay"></div>
<div id="toast"></div>

<script>
const SERVER_URL = "https://the-game-server-h9br.onrender.com";
const socket = io(SERVER_URL);

/* token */
const LS_TOKEN = "thegame_token";
function getToken(){
  try{
    let t = localStorage.getItem(LS_TOKEN);
    if(!t){
      t = (crypto?.randomUUID?.() || (Date.now()+"-"+Math.random()).replace(".",""));
      localStorage.setItem(LS_TOKEN, t);
    }
    return t;
  }catch{
    return (Date.now()+"-"+Math.random()).replace(".","");
  }
}
const myToken = getToken();

let room="", state=null, myHand=[], selectedCard=null;
let armedPing=null;
let myStats={games:0,wins:0,losses:0};
let lastPassHint=false;

const pileEls = {};
const cardEls = new Map();

/* Persist Lobby + Name */
const LS_ROOM="thegame_room", LS_NAME="thegame_name";
function saveInputs(){
  try{
    localStorage.setItem(LS_ROOM, document.getElementById("room").value.trim());
    localStorage.setItem(LS_NAME, document.getElementById("name").value.trim());
  }catch{}
}
function loadInputs(){
  try{
    const r=localStorage.getItem(LS_ROOM)||"";
    const n=localStorage.getItem(LS_NAME)||"";
    if(r) document.getElementById("room").value=r;
    if(n) document.getElementById("name").value=n;
  }catch{}
}

/* Toast */
let toastTimer=null;
function toast(text){
  const t=document.getElementById("toast");
  t.innerText=text;
  t.style.display="block";
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.style.display="none", 1700);
}

/* Overlay */
function showOverlay(html){
  const ov=document.getElementById("overlay");
  ov.innerHTML=`<div class="box">${html}</div>`;
  ov.style.display="flex";
}
function hideOverlay(){
  const ov=document.getElementById("overlay");
  ov.style.display="none";
  ov.innerHTML="";
}

/* robust join */
let joinRetryTimer=null;
let joinRetryCount=0;
function robustJoin(){
  if(!room){
    try{ room = (localStorage.getItem(LS_ROOM)||"").trim(); }catch{}
  }
  if(!room) return;
  const name =
    (document.getElementById("name")?.value || "").trim() ||
    (()=>{ try{ return (localStorage.getItem(LS_NAME)||"").trim(); }catch{ return ""; }})();
  socket.emit("join", { room, name, token: myToken });
}

function scheduleJoinRetry(){
  clearTimeout(joinRetryTimer);
  joinRetryCount = Math.min(joinRetryCount + 1, 6);
  const delay = 500 + joinRetryCount*350;
  joinRetryTimer = setTimeout(()=>robustJoin(), delay);
}

window.addEventListener("load", ()=>{
  loadInputs();
  document.getElementById("room").addEventListener("input", saveInputs);
  document.getElementById("name").addEventListener("input", saveInputs);
});

/* auto rejoin */
socket.on("connect", () => {
  joinRetryCount = 0;
  robustJoin();
});
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible" && socket.connected) robustJoin();
});

/* Create/Join */
function create(){
  saveInputs();
  room=document.getElementById("room").value.trim();
  if(!room) return alert("Bitte Lobby-Code eingeben");
  const maxPlayers=Math.max(2, Math.min(4, parseInt(document.getElementById("maxPlayers").value||"2")));
  socket.emit("create", { room, maxPlayers });
  robustJoin();
}
function join(){
  saveInputs();
  room=document.getElementById("room").value.trim();
  if(!room) return alert("Bitte Lobby-Code eingeben");
  robustJoin();
}

/* events */
socket.on("errorMsg", (msg)=> {
  alert(msg);
  if(String(msg).toLowerCase().includes("lobby existiert nicht")){
    scheduleJoinRetry();
  }
});

socket.on("state", (s)=>{ state=s; render(); });
socket.on("hand", (hand)=>{ myHand=hand||[]; renderHand(); });
socket.on("stats", (s)=>{ myStats=s||myStats; render(); });

/* Rules */
function isValid(card, pileName, pileValue){
  return pileName.startsWith("up")
    ? (card>pileValue || card===pileValue-10)
    : (card<pileValue || card===pileValue+10);
}
function hasAnyLegalMove(){
  if(!state) return false;
  for(const c of (myHand||[])){
    for(const p in state.piles){
      if(isValid(c, p, state.piles[p])) return true;
    }
  }
  return false;
}
function minPlaysThisTurn(){
  return (state && state.deckCount===0) ? 1 : 2;
}

/* Startpref */
function sendStartPref(pref){
  socket.emit("startPref", { room, token: myToken, pref });
}

/* Ping chips */
function setArmedPing(typeOrNull){
  armedPing=typeOrNull;
  document.getElementById("chipHave").classList.toggle("armed", armedPing==="have");
  document.getElementById("chipDont").classList.toggle("armed", armedPing==="dont");
}
["chipHave","chipDont"].forEach(id=>{
  const el=document.getElementById(id);

  el.addEventListener("dragstart",(e)=>{
    e.dataTransfer.setData("pingType", el.dataset.type);
    try{ e.dataTransfer.effectAllowed="copy"; }catch{}
  });

  el.addEventListener("click", ()=>{
    const t=el.dataset.type;
    setArmedPing(armedPing===t?null:t);
    toast(armedPing ? "Ping abgew√§hlt" : (t==="have" ? "üëÄ Ping gew√§hlt ‚Äì tippe einen Stapel" : "üö´ Ping gew√§hlt ‚Äì tippe einen Stapel"));
  });
});
function sendPilePing(pile, type){
  if(!room) return toast("Erst Lobby beitreten.");
  socket.emit("pilePing", { room, pile, type });
}

/* Flying animation */
function animateCardToPile(cardValue, pileName){
  const fromEl=cardEls.get(cardValue);
  const toEl=pileEls[pileName];
  if(!fromEl || !toEl) return;

  const fr=fromEl.getBoundingClientRect();
  const tr=toEl.getBoundingClientRect();
  const startX=fr.left+fr.width/2, startY=fr.top+fr.height/2;
  const endX=tr.left+tr.width/2, endY=tr.top+tr.height/2;

  const fly=document.createElement("div");
  fly.className="flyingCard";
  fly.textContent=cardValue;
  fly.style.left=startX+"px";
  fly.style.top=startY+"px";
  document.body.appendChild(fly);

  const dir=pileName.startsWith("up") ? -1 : 1;
  const midX=(startX+endX)/2;
  const midY=(startY+endY)/2 + dir*90;

  const anim=fly.animate([
    { transform:`translate(-50%, -50%) scale(1)`, opacity:1, offset:0, left:startX+"px", top:startY+"px" },
    { transform:`translate(-50%, -50%) scale(1.06)`, opacity:1, offset:0.55, left:midX+"px", top:midY+"px" },
    { transform:`translate(-50%, -50%) scale(0.98)`, opacity:0.95, offset:1, left:endX+"px", top:endY+"px" }
  ], { duration:440, easing:"cubic-bezier(.2,.9,.2,1)" });

  anim.onfinish=()=>fly.remove();
}

function render(){
  if(!state) return;

  const joined = Object.keys(state.players||{}).length;
  document.getElementById("lobbyInfo").innerText = `Lobby: ${state.room} ‚Ä¢ Spieler: ${joined}/${state.maxPlayers}`;
  document.getElementById("deckInfo").innerText = `Deck: ${state.deckCount}`;
  document.getElementById("statsInfo").innerText = `Stats: ${myStats.wins||0}W / ${myStats.losses||0}L (Games: ${myStats.games||0})`;

  const isMyTurn = state.status==="playing" && state.turnToken===myToken;
  const played = state.playedThisTurn?.[myToken] ?? 0;
  const minPlays = minPlaysThisTurn();

  const ring=document.getElementById("turnRing");
  ring.classList.remove("spinning","myTurn","otherTurn");

  if(state.status==="waiting"){
    document.getElementById("turnInfo").innerText = `Warte bis Lobby voll ist‚Ä¶ (${joined}/${state.maxPlayers})`;
  } else if(state.status==="choosing_start"){
    document.getElementById("turnInfo").innerText = `Start w√§hlen‚Ä¶`;
  } else if(state.status==="playing"){
    document.getElementById("turnInfo").innerText = isMyTurn
      ? `DEIN ZUG ‚Ä¢ gespielt: ${played}/${minPlays} ${state.deckCount===0 ? "(Deck leer)" : ""}`
      : `Jemand anderes ist dran`;

    if (isMyTurn) ring.classList.add("myTurn","spinning");
    else ring.classList.add("otherTurn");
  } else {
    document.getElementById("turnInfo").innerText = "";
  }

  const endBtn=document.getElementById("endTurnBtn");
  const canPass = isMyTurn && !hasAnyLegalMove();
  endBtn.style.display = (isMyTurn && (played>=minPlays || canPass)) ? "inline-block" : "none";

  if(isMyTurn && canPass && !lastPassHint){
    toast("Kein legaler Zug ‚Üí du kannst passen (Zug beenden).");
    lastPassHint=true;
  }
  if(!isMyTurn) lastPassHint=false;

  if(state.status==="choosing_start"){
    const myMade = !!state.start?.made?.[myToken];
    const madeCount = Object.values(state.start?.made || {}).filter(Boolean).length;
    showOverlay(`
      <h2>Wer soll anfangen?</h2>
      <p style="color:var(--muted); margin-top:0;">Schau dir deine Karten an und w√§hle:</p>
      <div class="choiceRow">
        <button class="choiceBtn" ${myMade?"disabled":""} onclick="sendStartPref('can')">‚úÖ Ich kann starten</button>
        <button class="choiceBtn secondary" ${myMade?"disabled":""} onclick="sendStartPref('not')">üôè Bitte nicht ich</button>
      </div>
      <div class="choiceStatus">
        ${myMade ? "Du hast gew√§hlt. Warte auf die anderen‚Ä¶" : "Du hast noch nicht gew√§hlt."}
        <br/>Entscheidungen: ${madeCount}/${state.maxPlayers}
      </div>
    `);
  } else if(state.status==="win" || state.status==="lose"){
    showOverlay(`
      <h2>${state.status==="win" ? "üéâ GEWONNEN" : "üíÄ VERLOREN"}</h2>
      <p style="color:var(--muted); margin-top:0;">Rematch startet neue Partie, Stats bleiben.</p>
      <button onclick="rematch()">Rematch</button>
    `);
  } else {
    hideOverlay();
  }

  const pilesDiv=document.getElementById("piles");
  pilesDiv.innerHTML="";

  const order = ["up1","up2","down1","down2"];
  for(const p of order){
    if(!(p in state.piles)) continue;

    const val = state.piles[p];
    const d = document.createElement("div");
    d.className = "pile " + (p.startsWith("up") ? "up" : "down");

    if(selectedCard!==null && isValid(selectedCard, p, val)) d.classList.add("valid");

    const arrow = document.createElement("div");
    arrow.className = "arrow";
    arrow.textContent = p.startsWith("up") ? "‚Üë" : "‚Üì";
    d.appendChild(arrow);

    const v = document.createElement("div");
    v.textContent = val;
    d.appendChild(v);

    pileEls[p] = d;

    const ping = state.pilePings?.[p];
    if(ping){
      const badge=document.createElement("div");
      badge.className="pilePing";
      badge.textContent = (ping.type==="dont") ? "üö´" : "üëÄ";
      d.appendChild(badge);
      if(ping.type==="dont") d.classList.add("blocked");
    }

    d.addEventListener("dragover",(e)=>e.preventDefault());
    d.addEventListener("drop",(e)=>{
      e.preventDefault();
      const type=e.dataTransfer.getData("pingType");
      if(type==="have"||type==="dont") sendPilePing(p,type);
    });

    d.onclick=()=>{
      if(armedPing){
        sendPilePing(p, armedPing);
        setArmedPing(null);
        toast("Ping gesetzt");
        return;
      }
      tryPlay(p);
    };

    pilesDiv.appendChild(d);
  }

  renderHand();
}

function renderHand(){
  const handDiv=document.getElementById("hand");
  handDiv.innerHTML="";
  cardEls.clear();

  (myHand||[]).forEach((c)=>{
    const el=document.createElement("div");
    el.className="card" + (selectedCard===c ? " selected" : "");
    el.innerText=c;
    el.dataset.value = c;
    cardEls.set(c, el);

    el.onclick=()=>{ selectedCard=c; render(); };
    handDiv.appendChild(el);
  });
}

function tryPlay(pile){
  if(!state || state.status!=="playing") return;
  if(state.turnToken!==myToken) return toast("Nicht dein Zug.");
  if(selectedCard===null) return toast("Erst eine Karte ausw√§hlen.");

  const ok=isValid(selectedCard, pile, state.piles[pile]);
  if(!ok) return toast("Dort nicht erlaubt.");

  animateCardToPile(selectedCard, pile);
  socket.emit("play", { room, token: myToken, card:selectedCard, pile });
  selectedCard=null;
}

function endTurn(){
  socket.emit("endTurn", { room, token: myToken });
}

function rematch(){
  socket.emit("rematch", { room });
  selectedCard=null;
  setArmedPing(null);
}
</script>
</body>
</html>
