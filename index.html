<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>The Game</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body{
  margin:0;
  padding:14px;
  background:#121212;
  color:#f2f2f2;
  font-family:system-ui;
  text-align:center;
}

button,input{
  padding:12px;
  border-radius:12px;
  border:none;
  font-size:16px;
}

button{background:#4caf50;color:#000}
.card{
  display:inline-block;
  padding:16px;
  margin:6px;
  background:#2c2c2c;
  border-radius:14px;
  font-size:18px;
}
.card.selected{outline:2px solid #4caf50}

.piles{
  display:grid;
  grid-template-columns:repeat(2,160px);
  gap:14px;
  justify-content:center;
}
.pile{
  background:#1e1e1e;
  border:2px solid #555;
  border-radius:16px;
  padding:14px;
  font-size:26px;
  position:relative;
}

.flyingCard{
  position:fixed;
  z-index:9999;
  background:#2c2c2c;
  padding:16px;
  border-radius:14px;
  transform:translate(-50%,-50%);
}

/* üî• FX LAYER */
#fxLayer{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:100000;
}

.spark{
  position:absolute;
  width:16px;
  height:16px;
  border-radius:999px;
  background:#ffd166;
  filter:drop-shadow(0 0 16px #ffd166);
  box-shadow:0 0 24px #ffd166;
}
</style>
</head>

<body>

<h1>The Game üÉè</h1>

<input id="room" placeholder="Lobby">
<button onclick="create()">Create</button>
<button onclick="join()">Join</button>

<div class="piles" id="piles"></div>

<h2>Hand</h2>
<div id="hand"></div>

<button onclick="endTurn()">Zug beenden</button>

<div id="fxLayer"></div>

<script>
const socket = io("https://the-game-server-h9br.onrender.com");

let room="",state=null,myHand=[],selected=null;
const pileEls={},cardEls=new Map();

function create(){
  room=document.getElementById("room").value;
  socket.emit("create",{room,maxPlayers:2});
  join();
}
function join(){
  socket.emit("join",{room,name:"Spieler"});
}

socket.on("state",s=>{state=s;render();});
socket.on("hand",h=>{myHand=h;renderHand();});
socket.on("errorMsg",m=>alert(m));

function animateCard(card,pile){
  const cEl=cardEls.get(card);
  const pEl=pileEls[pile];
  const fr=cEl.getBoundingClientRect();
  const tr=pEl.getBoundingClientRect();

  const el=document.createElement("div");
  el.className="flyingCard";
  el.innerText=card;
  el.style.left=fr.left+fr.width/2+"px";
  el.style.top=fr.top+fr.height/2+"px";
  document.body.appendChild(el);

  el.animate([
    {transform:"translate(-50%,-50%)"},
    {transform:`translate(${tr.left-fr.left}px,${tr.top-fr.top}px)`}
  ],{duration:2000,easing:"ease-in-out"}).onfinish=()=>el.remove();
}

function spawnSpark(pileEl){
  const fx=document.getElementById("fxLayer");
  const r=pileEl.getBoundingClientRect();
  const cx=r.left+r.width/2;
  const cy=r.top+r.height/2;

  for(let i=0;i<14;i++){
    const s=document.createElement("div");
    s.className="spark";
    s.style.left=cx+"px";
    s.style.top=cy+"px";
    fx.appendChild(s);

    const a=Math.random()*Math.PI*2;
    const d=80;
    s.animate([
      {transform:"translate(-50%,-50%) scale(1)",opacity:1},
      {transform:`translate(${Math.cos(a)*d}px,${Math.sin(a)*d}px) scale(0)`,opacity:0}
    ],{duration:1200,easing:"ease-out"}).onfinish=()=>s.remove();
  }
}

function render(){
  const p=document.getElementById("piles");
  p.innerHTML="";
  for(const k in state.piles){
    const d=document.createElement("div");
    d.className="pile";
    d.innerText=state.piles[k];
    pileEls[k]=d;
    d.onclick=()=>tryPlay(k);
    p.appendChild(d);
  }
}

function renderHand(){
  const h=document.getElementById("hand");
  h.innerHTML="";
  cardEls.clear();
  myHand.forEach(c=>{
    const d=document.createElement("div");
    d.className="card"+(selected===c?" selected":"");
    d.innerText=c;
    d.onclick=()=>{selected=c;renderHand();}
    cardEls.set(c,d);
    h.appendChild(d);
  });
}

function tryPlay(pile){
  if(selected==null) return;
  const prev=state.piles[pile];
  const diff=selected-prev;

  animateCard(selected,pile);

  if((pile.startsWith("up")&&diff===-10)||(pile.startsWith("down")&&diff===10)){
    spawnSpark(pileEls[pile]);
  }

  socket.emit("play",{room,card:selected,pile});
  selected=null;
}

function endTurn(){
  socket.emit("endTurn",{room});
}
</script>
</body>
</html>
